name: Continuous Integration 

on: [push]

jobs:

  build:
    runs-on: ubuntu-latest
    container: node:18

    services:
      nats:
        image: nats

    env:
      NATS_HOST: nats
      NATS_USER: ruser
      NATS_PASSWORD: T0pS3cr3t
 
    steps:
    - uses: actions/checkout@v1
    - name: Build project
      run: docker-compose build
    - name: Setup test environment
      run: |
        docker-compose up -d mysql
        sleep 5
        docker-compose run web npm run db:init
    - name: Run linter
      run: docker-compose run web npm run lint
    - name: Run typecheck
      run: docker-compose run web npm run typecheck
    - name: Run tests
      run: docker-compose run web npm test
